<!DOCTYPE html>
<html>
<head>
	
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/analog.css">
	<link rel="stylesheet" type="text/css" href="css/pygments.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

	<style type="text/css">
		
		

	</style>

	<title></title>
</head>

<body>

	<div class="wrapper">
		<!-- <header class="header">Header</header> -->

		<div class=main>
			<h1>storageHeapMaps</h1>

Storage heat maps show what partitions are being used across different type of operating systems.   The idea for this came up when I had a certain type of OS that was filling up the boot, so I thought it would be good if I could see a correlation between OS type and partition usage on those OS's.  <br>
<br>
I used puppet to push out a configuration that would setup a cron to run a collection script once an hour.  This data is pushed up into elastic search, and then a flask application reads that data and reports on it.  The actual graphs are created with the <a href="https://plot.ly/javascript/">plotly.js</a>
 javascript library.  <br>
<br>
<img src="static/data/storageHeapMaps-heatMaps.png" alt="img">
<br>
<br>
<h2>pushDisk.py</h2>

This is the script that runs hourly and pushes the data back up to elastic search.<br>
<br>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="source"><pre><span></span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>

<span class="n">plat</span> <span class="o">=</span>  <span class="nb">map</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">platform</span><span class="o">.</span><span class="n">dist</span><span class="p">())</span>

<span class="k">if</span> <span class="n">plat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;redhat&quot;</span><span class="p">:</span>
  <span class="n">plat_name</span><span class="o">=</span><span class="s2">&quot;centos&quot;</span>

<span class="n">host</span>  <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;hostname&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="n">diskData</span> <span class="o">=</span> <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s2">&quot;df&quot;</span><span class="p">,</span> <span class="s2">&quot;-Ph&quot;</span> <span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">diskData</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
  <span class="n">items</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span>
 <span class="ow">not</span> <span class="n">items</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/mnt&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> 
 <span class="ow">not</span> <span class="n">items</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/var/lib/docker&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
 <span class="ow">not</span> <span class="n">items</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/dev&quot;</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">items</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/sys&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> 
 <span class="ow">not</span> <span class="n">items</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;/run&quot;</span><span class="p">)</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s2">&quot;&quot;&quot;{&quot;Device&quot;: &quot;</span><span class="si">%s</span><span class="s2">&quot;, &quot;percent&quot;: </span><span class="si">%s</span><span class="s2">}&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">))</span>

<span class="n">cmd</span><span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">curl -XPOST &quot;http://esearch.rest.of.url:9200/inventory/disk/</span><span class="si">%s</span><span class="s2">&quot; -d &#39;</span>
<span class="s2">{</span>
<span class="s2">&quot;host&quot;: &quot;</span><span class="si">%s</span><span class="s2">&quot;,</span>
<span class="s2">&quot;os&quot;: &quot;</span><span class="si">%s</span><span class="s2">&quot;,</span>
<span class="s2">&quot;data&quot;: [</span><span class="si">%s</span><span class="s2">]</span>
<span class="s2">}</span>
<span class="s2">&#39;</span>
<span class="s2">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">plat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">plat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">)</span>


<span class="k">print</span> <span class="n">cmd</span>

<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</pre></div>
</td></tr></table>
<br>
<br>
<h2>Source</h2>
All the source for the web application can be found on <a href="https://github.com/analogpixel/storageHeatMaps">github</a>
<br>
<br>
<div class="tag">publish</div>

		</div>

		<aside class="aside aside-1"></aside>
		<aside class="aside aside-2"><br><br><img src=img/helloMyNameIs.png width=200 >
		    <br>
		    <a href="https://www.analogpixel.org">Home</a><br>
		    <a href="https://github.com/analogpixel/">GitHub</a><br>
			<a href="http://analog.smugmug.com/">Photos</a><br>
			<a href="https://365drawingsonthewall.tumblr.com/">Doodles</a><br>
			<a href="mailto://matt.poepping@gmail.com">Email me</a><br>
		</aside>
		<!-- <footer class=footer>Footer</footer> -->
	</div>

	<script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                asciimath2jax: {
                delimiters: [['$|','|$']]
                }
            });
            </script>
            
    <!-- http://docs.mathjax.org/en/latest/start.html -->
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_CHTML"></script>

</body>
</html>