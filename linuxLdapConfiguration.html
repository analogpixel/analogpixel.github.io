<!DOCTYPE html>
<html>
<head>
	
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/analog.css">
	<link rel="stylesheet" type="text/css" href="css/pygments.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

	<style type="text/css">
		
		

	</style>

	<title></title>
</head>

<body>

	<div class="wrapper">
		<!-- <header class="header">Header</header> -->

		<div class=main>
			<h1>Configuring LDAP single sign on</h1>

This document will cover the configuration of single sign in the Seagate environment. Since ldap.seagate.com doesn't have the unix user scheme installed, many default values are assumed (group,shell,homedir)<br>
<br>
<h2>Server Configuration</h2>
<h3>nslcd</h3>
There is a lot of assuming going on since we don't capture the users default
shell or groupid in ldap, so the defaults will be: /home/<uid> for the home,
/bin/bash for the shell, and 100 for the default group (user in unix)<br>
<br>
Since the unix schema isn't installed on the ldap server, you'll need to
specify the values with map entries.<br>
<br>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="source"><pre><span></span>uri ldaps://ldap.seagate.com
base ou=people,o=seagate.com,o=sds
base passwd ou=people,o=seagate.com,o=sds
scope sub
timelimit 60
tls_reqcert never
filter passwd (objectClass=inetOrgPerson)
map     passwd uidNumber      uid
map     passwd gidNumber      &quot;100&quot;
map     passwd homeDirectory  &quot;/home/$uid&quot;
map     passwd loginShell     &quot;/bin/bash&quot;
</pre></div>
</td></tr></table>
<br>
<br>
<h3>pam_ldap.conf</h3>
This file is read by the pam_ldap.so module and should have the same
values as the ldap.conf and openldap/ldap.conf file<br>
<br>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="source"><pre><span></span>host ldap.seagate.com
base ou=people,o=seagate.com,o=sds
uri ldaps://ldap.seagate.com
scope subtree
timelimit 0
bind_timelimit 90
</pre></div>
</td></tr></table>
<br>
<br>
<h3>Certificaite configuration</h3>
certs need to be in /etc/openldap/cacerts  and then you need to run
/usr/sbin/cacertdir_rehash /etc/openldap/cacerts  which will add links
to make them active. you can get the cert from: <b>http://pki.seagate.com/root</b><br>
<br>
<h3>openldap/ldap.conf</h3>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span></span>uri ldaps://ldap.seagate.com
base o=seagate.com,o=sds
TLS_REQCERT never
</pre></div>
</td></tr></table>
<br>
<br>
<h3>nsswitch.conf</h3>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="source"><pre><span></span>passwd:     files ldap
shadow:     files
group:      files
hosts:      files dns
bootparams: nisplus [NOTFOUND=return] files
ethers:     files
netmasks:   files
networks:   files
protocols:  files
rpc:        files
services:   files
netgroup:   nisplus
publickey:  nisplus
automount:  files nisplus
aliases:    files nisplus
</pre></div>
</td></tr></table>
<br>
<br>
<h3>system-auth</h3>
<h4>The four pam modules</h4>
of the four pam modules, auth will be the only one modified to do ldap lookups. Session will be modified so home directories will be created for users if they don't exist.<br>
<br>
<li class=bullet1><i>auth</i> : This module is used for authenticating. If something needs to check if a password is valid, it'll call the auth module</li>
<li class=bullet1><i>account</i> : This module will check if the account has access to a resource. If their password is expired, this module will catch that.</li>
<li class=bullet1><i>password</i> :  This module is used to change the users password</li>
<li class=bullet1><i>session</i> : this module manges the users sessions. If you needed to mount a users home directory it would happen here.</li>

<h4>options to the pam modules</h4>
Everywhere that pam_unix is called, pam_ldap should also be called.
<li class=bullet1><i>minimum_uid</i> : sets the lowest uid that is allowed to login via ldap if you have a user that has an employee id less than this (100) then they won't be able to login.</li>
<li class=bullet1><i>try_first_pass</i> : use the password supplied when the user initially types in their password (don't ask for it again)  If that password fails, ask again.</li>
<li class=bullet1><i>use_first_pass</i> : use the password supplied when the user initially types in their password, if it fails, don't ask again.</li>

<h4>pam states</h4>
<li class=bullet1><i>sufficient</i> : an option of sufficient means that if this module returns a positive result, then stop processing and pass the entire section.</li>
<li class=bullet1><i>required</i> : an option of required means that if this module returns a failure, then continue running modules, but fail when finished.</li>

<li class=bullet4>Pam configurations for ldap</li>
 both system-auth and password-auth are used by pam.d configurations, instead of
 trying to update all pam.d modules to use system-auth, I just updated both
 system-auth and password-auth to work correctly with ldap.<br>
<br>
I've also added pam_mkhomedir.so which will create a users home directory if
it does not exist when they login.  The default directory of /etc/skel will
be used to fill in the initial directory.<br>
<br>
<h4>system-auth</h4>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="source"><pre><span></span><span class="gh">#</span>%PAM-1.0
<span class="gh">#</span> This file is auto-generated.
<span class="gh">#</span> User changes will be destroyed the next time authconfig is run.
auth        required      pam_env.so
auth        sufficient    pam_unix.so nullok try_first_pass
auth        sufficient    pam_ldap.so try_first_pass debug
auth        requisite     pam_succeed_if.so uid &gt;= 500 quiet
auth        required      pam_deny.so

account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid &lt; 500 quiet
account     required      pam_permit.so

password    requisite     pam_cracklib.so try_first_pass retry=3 type=
password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok
password    required      pam_deny.so

session     optional      pam_keyinit.so revoke
session     required      pam_limits.so
session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session     required      pam_unix.so
session     required      pam_mkhomedir.so skel=/etc/skel umask=0022
</pre></div>
</td></tr></table>
<br>
<br>
<h4>password-auth</h4>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="source"><pre><span></span><span class="gh">#</span>%PAM-1.0
<span class="gh">#</span> This file is auto-generated.
<span class="gh">#</span> User changes will be destroyed the next time authconfig is run.
auth        required      pam_env.so
auth        sufficient    pam_unix.so nullok try_first_pass
auth        sufficient    pam_ldap.so try_first_pass debug
auth        requisite     pam_succeed_if.so uid &gt;= 500 quiet
auth        required      pam_deny.so

account     required      pam_unix.so
account     sufficient    pam_localuser.so
account     sufficient    pam_succeed_if.so uid &lt; 500 quiet
account     required      pam_permit.so

password    requisite     pam_cracklib.so try_first_pass retry=3 type=
password    sufficient    pam_unix.so md5 shadow nullok try_first_pass use_authtok
password    required      pam_deny.so

session     optional      pam_keyinit.so revoke
session     required      pam_limits.so
session     [success=1 default=ignore] pam_succeed_if.so service in crond quiet use_uid
session     required      pam_unix.so
session     required      pam_mkhomedir.so skel=/etc/skel umask=0022
</pre></div>
</td></tr></table>
<br>
<br>

<h2>puppet configuration</h2>
This configuration will work for Redhat based machines (cent/fedora/rhel). Debian based
machines will have a slightly different configuration.<br>
<br>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72</pre></div></td><td class="code"><div class="source"><pre><span></span>     <span class="k">package</span> <span class="p">{</span><span class="s">&quot;nss-pam-ldapd&quot;</span><span class="p">:}</span>
     <span class="k">package</span> <span class="p">{</span><span class="s">&quot;nscd&quot;</span><span class="p">:</span> <span class="p">}</span>
     <span class="k">package</span> <span class="p">{</span><span class="s">&quot;openldap-clients&quot;</span><span class="p">:</span> <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/pam.d/system-auth&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/system-auth&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
     <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/pam.d/password-auth&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/password-auth&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
     <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/openldap/ldap.conf&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/openldap_ldap.conf&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
    <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/ldap.conf&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/openldap_ldap.conf&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
     <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/pam_ldap.conf&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/pam_ldap.conf&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
     <span class="p">}</span>

     <span class="k">service</span> <span class="p">{</span><span class="s">&quot;nslcd&quot;</span><span class="p">:</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="s">&quot;running&quot;</span><span class="p">,</span>
       <span class="na">enable</span> <span class="o">=&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
       <span class="na">require</span> <span class="o">=&gt;</span> <span class="k">File</span><span class="p">[</span><span class="s">&#39;/etc/nslcd.conf&#39;</span><span class="p">],</span>
     <span class="p">}</span>

     <span class="k">service</span> <span class="p">{</span><span class="s">&quot;nscd&quot;</span><span class="p">:</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="s">&quot;running&quot;</span><span class="p">,</span>
       <span class="na">enable</span> <span class="o">=&gt;</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
     <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/nslcd.conf&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/nslcd.conf&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
       <span class="k">notify</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="k">Service</span><span class="p">[</span><span class="s">&#39;nslcd&#39;</span><span class="p">],</span> <span class="k">Service</span><span class="p">[</span><span class="s">&#39;nscd&#39;</span><span class="p">]</span> <span class="p">],</span>
     <span class="p">}</span>

     <span class="k">file</span> <span class="p">{</span><span class="s">&quot;/etc/nsswitch.conf&quot;</span><span class="p">:</span>
       <span class="na">source</span> <span class="o">=&gt;</span> <span class="s">&quot;/vagrant/manifests/nsswitch.conf&quot;</span><span class="p">,</span>
       <span class="na">ensure</span> <span class="o">=&gt;</span> <span class="k">file</span><span class="p">,</span>
       <span class="na">owner</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">group</span>  <span class="o">=&gt;</span> <span class="na">root</span><span class="p">,</span>
       <span class="na">mode</span>   <span class="o">=&gt;</span> <span class="mi">644</span><span class="p">,</span>
       <span class="k">notify</span> <span class="o">=&gt;</span> <span class="k">Service</span><span class="p">[</span><span class="s">&#39;nslcd&#39;</span><span class="p">],</span>
     <span class="p">}</span>
</pre></div>
</td></tr></table>
<br>
<br>

<h2>Vagrant configuration</h2>
	
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="source"><pre><span></span><span class="c1">#+begin_src vagrant :tangle c:/data/rhel_ldapclient/Vagrantfile</span>
<span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>

<span class="c1"># Every Vagrant development environment requires a box. You can search for</span>
<span class="c1"># boxes at https://atlas.hashicorp.com/search.</span>
<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://developer.nrel.gov/downloads/vagrant-boxes/CentOS-6.4-x86_64-v20131103.box&quot;</span>
<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos6&quot;</span>

<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span>  <span class="s2">&quot;puppet&quot;</span>

<span class="k">end</span>
</pre></div>
</td></tr></table>
<br>
<br>

<h2>Baseline</h2>
<h3>Timing</h3>
<li class=bullet1>Initial login, or login without nscd is about 25 seconds</li>
<li class=bullet1>login with nscd after cache is about 3 seconds</li>

<h3>Logging</h3>
<h4>/var/log/secure</h4>
failure on local authenticaion, and then success on ldap authentication<br>
<br>
<table class="sourcetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="source"><pre><span></span>Jan 26 19:58:40 localhost sshd[3239]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=10.0.2.2  user=527855
Jan 26 19:58:51 localhost sshd[3239]: Accepted password for 527855 from 10.0.2.2 port 53439 ssh2
Jan 26 19:58:51 localhost sshd[3239]: pam_unix(sshd:session): session opened for user 527855 by (uid=0)
</pre></div>
</td></tr></table>
<br>
<br>
<h2>Testing and Debugging</h2>
<h3>testing ldap settings</h3>
<li class=bullet1>-W ask for password (-w to supply a password)</li>
<li class=bullet1>-b o=seagate.com,o=SDS  (set the base if ldap.conf isn't setup)</li>
<li class=bullet1>-H ldap://ldap.seagate.com (set the host if ldap.conf isn't setup)</li>

ldapsearch -W -D uid=527855,ou=people,o=seagate.com,o=sds -b o=SDS uid=527855<br>
<br>
<h3>Testing nslcd</h3>
To debug nslcd, stop the nslcd service (and the nscd if it is running) and run nslcd -d to start the program in debug mode.<br>
<br>
<h3>Errors</h3>
<h3>missing attribute "gidNumber"</h3>
If there isn't a mapping in the nslcd.conf and the default value isn't in ldap, a message
like this will show up.  See the nslcd.conf for examples on how to setup mappings.<br>
<br>
<h2>links</h2>
<li class=bullet1><a href="https://www.howtoforge.com/linux_ldap_authentication">Configuring a client</a>
</li>
<li class=bullet1><a href="http://docs.fedoraproject.org/en-US/Fedora/15/html/Deployment_Guide/chap-SSSD_User_Guide-Setting_Up_SSSD.html">SSSD link</a>
</li>
<li class=bullet1><a href="http://geekdom.wesmo.com/2014/05/16/embracing-sssd-in-linux/">SSSD overview</a>
</li>
<li class=bullet1><a href="https://wiki.debian.org/LDAP/NSS">Debian LDAP docs</a>
</li>
<li class=bullet1><a href="http://linux.die.net/man/5/pam.d">PAM man page</a>
</li>
<li class=bullet1><a href="http://arthurdejong.org/nss-pam-ldapd/pam_ldap.8">pam_ldap man page</a>
</li>
<li class=bullet1><a href="http://arthurdejong.org/nss-pam-ldapd/setuphttp://arthurdejong.org/nss-pam-ldapd/setup">nss-pam-ldapd setup</a>
</li>
<li class=bullet1><a href="https://linux.web.cern.ch/linux/docs/nslcd.conf.example">example nslcd file</a>
</li>
<li class=bullet1><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Directory_Server/8.1/html/Configuration_and_Command_Reference/Configuration_Command_File_Reference-Command_Line_Utilities-ldapsearch.html">Redhat Docs on ldapsearch</a>
</li>

<hr>
<div class="tag">ldap</div>
<div class="tag">seagate</div>
<div class="tag">nscd</div>
<div class="tag">nslcd</div>
<div class="tag">sss</div>
<div class="tag">publish</div>

		</div>

		<aside class="aside aside-1"></aside>
		<aside class="aside aside-2"><br><br><a href="http://www.analogpixel.org"><img src=img/helloMyNameIs.png width=200 border=0></a>
		    <br>
		    <a href="http://www.analogpixel.org">Home</a><br>
		    <a href="https://github.com/analogpixel/">GitHub</a><br>
			<a href="http://analog.smugmug.com/">Photos</a><br>
			<a href="https://analog.smugmug.com/Whiteboard/">Doodles</a><br>
			<a href="https://analog.smugmug.com/Make-Things/">Random Things</a><br>
			<a href="mailto://matt.poepping@gmail.com">Email me</a><br>
		</aside>
		<!-- <footer class=footer>Footer</footer> -->
	</div>

	<script type="text/x-mathjax-config">
            MathJax.Hub.Config({
                asciimath2jax: {
                delimiters: [['$|','|$']]
                }
            });
            </script>
            
    <!-- http://docs.mathjax.org/en/latest/start.html -->
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=AM_CHTML"></script>

</body>
</html>